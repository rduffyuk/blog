{{- /* Mermaid.js conditional loading - only loads if diagrams present */ -}}
{{- /* data-cfasync="false" bypasses Cloudflare Rocket Loader which breaks ES modules */ -}}
<script type="module" data-cfasync="false">
  // Only initialize Mermaid if there are mermaid blocks on the page
  if (document.querySelector('.mermaid')) {
    const mermaid = await import('https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs');

    // Detect if dark mode is active (PaperMod theme uses .dark class on body)
    const isDark = document.body.classList.contains('dark');

    mermaid.default.initialize({
      startOnLoad: true,
      theme: isDark ? 'dark' : 'base',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
      themeVariables: isDark ? {
        // Dark mode: Vibrant high-contrast theme
        primaryColor: '#BB86FC',
        primaryTextColor: '#FFFFFF',
        primaryBorderColor: '#7C4DFF',
        lineColor: '#FFD700',
        secondaryColor: '#03DAC6',
        tertiaryColor: '#1E1E1E',
        noteBkgColor: '#7C4DFF',
        noteTextColor: '#FFFFFF',
        edgeLabelBackground: '#1E1E1E',
        clusterBkg: '#2D2D2D',
        clusterBorder: '#7C4DFF',
        fontSize: '16px'
      } : {
        // Light mode: MAXIMUM CONTRAST - dark colors on light background
        primaryColor: '#0D47A1',        // Very dark blue
        primaryTextColor: '#000000',    // Black text
        primaryBorderColor: '#01579B',  // Even darker blue
        lineColor: '#BF360C',           // Dark red-orange arrows
        secondaryColor: '#004D40',      // Dark teal
        tertiaryColor: '#FAFAFA',       // Light gray
        noteBkgColor: '#1565C0',
        noteTextColor: '#FFFFFF',
        edgeLabelBackground: '#FFFFFF',
        clusterBkg: '#E1F5FE',          // Light blue tint
        clusterBorder: '#0D47A1',
        fontSize: '16px'
      }
    });
  }
</script>
