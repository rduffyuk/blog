{{- /* Mermaid.js conditional loading - only loads if diagrams present */ -}}
{{- /* data-cfasync="false" bypasses Cloudflare Rocket Loader which breaks ES modules */ -}}
<script type="module" data-cfasync="false">
  // Only initialize Mermaid if there are mermaid blocks on the page
  if (document.querySelector('.mermaid')) {
    const mermaid = await import('https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs');

    // Detect if dark mode is active (PaperMod theme uses .dark class on body)
    const isDark = document.body.classList.contains('dark');

    mermaid.default.initialize({
      startOnLoad: true,
      theme: isDark ? 'dark' : 'base',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      // CRITICAL: Large base font size for readability
      fontSize: 20,
      // Ensure text wrapping for long labels
      wrap: true,
      // Add padding inside nodes for better text spacing
      curve: 'basis',
      themeVariables: isDark ? {
        // Dark mode: Vibrant high-contrast theme with LARGE text
        fontSize: '20px',
        primaryColor: '#7C4DFF',           // Bright purple (more vibrant)
        primaryTextColor: '#FFFFFF',       // White text
        primaryBorderColor: '#B388FF',     // Light purple border (higher contrast)
        lineColor: '#FFD700',              // Gold arrows
        secondaryColor: '#00E676',         // Bright green (instead of teal)
        tertiaryColor: '#1E1E1E',          // Dark background
        // Make nodes pop with strong borders
        nodeBorder: '#B388FF',
        mainBkg: '#7C4DFF',
        textColor: '#FFFFFF',
        // Clusters/subgraphs
        clusterBkg: '#424242',             // Medium gray
        clusterBorder: '#B388FF',          // Light purple
        // Edge labels
        edgeLabelBackground: '#1E1E1E',
        labelTextColor: '#FFFFFF'
      } : {
        // Light mode: ULTRA HIGH CONTRAST with LARGE text
        fontSize: '20px',
        primaryColor: '#FFFFFF',           // WHITE boxes (dark borders make them pop)
        primaryTextColor: '#000000',       // BLACK text (maximum contrast)
        primaryBorderColor: '#0D47A1',     // Very dark blue border (thick and bold)
        lineColor: '#D32F2F',              // Bright red arrows (highly visible)
        secondaryColor: '#1B5E20',         // Dark green
        tertiaryColor: '#FAFAFA',          // Off-white background
        // Force strong visual hierarchy
        nodeBorder: '#0D47A1',
        mainBkg: '#FFFFFF',
        textColor: '#000000',
        // Clusters/subgraphs with color
        clusterBkg: '#E3F2FD',             // Light blue background
        clusterBorder: '#1565C0',          // Blue border (thick)
        // Edge labels with high contrast
        edgeLabelBackground: '#FFFDE7',    // Light yellow background for labels
        labelTextColor: '#000000'          // Black label text
      }
    });
  }
</script>
